# Story 1.3: Database Setup

**Epic:** 1 - Foundation & Setup  
**Status:** Draft  
**Sprint:** 1-2 (Semanas 1-2)  
**Prioridade:** ðŸ”´ CrÃ­tica

---

## Story

**As a** developer,  
**I want** to set up PostgreSQL database with Prisma ORM and create the initial schema,  
**so that** the application can store and retrieve contact and newsletter data.

---

## Acceptance Criteria

1. Prisma installed and configured with PostgreSQL
2. Database schema created (Contact, Newsletter models)
3. Initial migration created and applied
4. Prisma Client generated and configured
5. Database connection working locally
6. Schema matches architecture specifications

---

## Tasks / Subtasks

- [ ] Task 1: Install Prisma (AC: 1)
  - [ ] Install Prisma CLI: `npm install -D prisma`
  - [ ] Install Prisma Client: `npm install @prisma/client`
  - [ ] Initialize Prisma: `npx prisma init`
  - [ ] Configure `prisma/schema.prisma` datasource

- [ ] Task 2: Create Database Schema (AC: 2, 6)
  - [ ] Create Contact model with all fields
  - [ ] Create Newsletter model
  - [ ] Add indexes (email, createdAt)
  - [ ] Configure table mappings (@@map)
  - [ ] Add field mappings (@map) for snake_case columns

- [ ] Task 3: Configure Prisma Client (AC: 4)
  - [ ] Create `lib/prisma.ts` singleton
  - [ ] Configure Prisma Client with proper connection handling
  - [ ] Add development vs production connection logic
  - [ ] Ensure singleton pattern (prevent multiple instances)

- [ ] Task 4: Create Initial Migration (AC: 3)
  - [ ] Run `npx prisma migrate dev --name init`
  - [ ] Verify migration files created
  - [ ] Verify database tables created
  - [ ] Test connection to database

- [ ] Task 5: Generate Prisma Client (AC: 4)
  - [ ] Run `npx prisma generate`
  - [ ] Verify Prisma Client generated
  - [ ] Verify types are available in TypeScript

- [ ] Task 6: Setup Environment Variables (AC: 5)
  - [ ] Update `.env.example` with DATABASE_URL template
  - [ ] Create `.env.local` with local database URL
  - [ ] Configure DATABASE_URL for PostgreSQL
  - [ ] Document connection string format

- [ ] Task 7: Verify Database Setup (AC: 5, 6)
  - [ ] Test Prisma Client connection
  - [ ] Verify schema matches architecture
  - [ ] Test basic queries (create, read)
  - [ ] Verify indexes are created

---

## Dev Notes

### Previous Story Insights
[From Story 1.1]
- Next.js 14 project initialized
- Project structure created
- TypeScript configured

### Database Schema
[Source: architecture/database-schema.md - Section 5]

**Prisma Schema:**
```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contact {
  id              String   @id @default(cuid())
  name            String
  email           String
  phone           String
  clinicName      String   @map("clinic_name")
  city            String
  state           String
  monthlyRevenue  String   @map("monthly_revenue")
  mainChallenge   String   @db.Text @map("main_challenge")
  referralSource  String?  @map("referral_source")
  acceptsEmails   Boolean  @default(false) @map("accepts_emails")
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@map("contacts")
  @@index([email])
  @@index([createdAt])
}

model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("newsletter_subscribers")
  @@index([createdAt])
}
```

**Note:** CalendlyEvent model is for future use (Fase 2) and can be included but not required for MVP.

### Migrations
[Source: architecture/database-schema.md - Section 5]

Migration commands:
- `npx prisma migrate dev --name init` - Create initial migration
- `npx prisma generate` - Generate Prisma Client
- `npx prisma db seed` - Optional seed data

### Prisma Client Singleton
[Source: architecture/source-tree.md]

Create `lib/prisma.ts` with singleton pattern to prevent multiple Prisma Client instances in development (hot reload issue).

Example pattern:
```typescript
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;
```

### Environment Variables
[Source: architecture/environment-variables.md]

DATABASE_URL format:
```
postgresql://digitaldog:password@localhost:5432/digitaldog_db
```

For local development, use PostgreSQL running in Docker or local installation.

### File Locations
[Source: architecture/source-tree.md]

- Schema: `prisma/schema.prisma`
- Migrations: `prisma/migrations/`
- Prisma Client: `lib/prisma.ts`

### TypeScript Guidelines
[Source: architecture/coding-standards.md]

- Use strict mode
- Prisma generates types automatically
- Use Prisma types for database models

### Testing
[Source: architecture/testing-strategy.md]

**Testing Standards:**
- Test database connection
- Test basic CRUD operations
- For this story: Manual testing of schema and connection sufficient
- Unit tests for Prisma Client usage in later stories

### Technical Constraints
- Prisma version must be 5.11 or higher
- PostgreSQL version must be 16 or higher
- Database must support Text type for mainChallenge field
- Indexes must be created for performance

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

---

