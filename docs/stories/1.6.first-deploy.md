# Story 1.6: First Deploy

**Epic:** 1 - Foundation & Setup  
**Status:** Draft  
**Sprint:** 1-2 (Semanas 1-2)  
**Prioridade:** ðŸ”´ CrÃ­tica

---

## Story

**As a** developer,  
**I want** to deploy the application to VPS with SSL configured and health check endpoint,  
**so that** the application is accessible in production with secure HTTPS connection.

---

## Acceptance Criteria

1. Application deployed to VPS successfully
2. SSL certificate configured (Let's Encrypt)
3. HTTPS accessible and working
4. Health check endpoint implemented and responding
5. All services running (Next.js, PostgreSQL, Nginx)
6. Environment validated in production

---

## Tasks / Subtasks

- [ ] Task 1: Prepare VPS Environment (AC: 1)
  - [ ] SSH into VPS using ssh_run.py or direct SSH
  - [ ] Verify Docker and docker-compose installed
  - [ ] Create project directory: `/var/www/digitaldog-website`
  - [ ] Clone GitHub repository
  - [ ] Verify project structure

- [ ] Task 2: Configure Environment Variables on VPS (AC: 6)
  - [ ] Create `.env` file on VPS with production values
  - [ ] Configure DATABASE_URL for production
  - [ ] Set DB_PASSWORD securely
  - [ ] Configure other required environment variables
  - [ ] Ensure .env is not committed to Git

- [ ] Task 3: Initial Deploy (AC: 1, 5)
  - [ ] Run docker-compose build
  - [ ] Run docker-compose up -d
  - [ ] Verify all containers start successfully
  - [ ] Check container logs for errors
  - [ ] Verify Next.js accessible on port 3000 internally

- [ ] Task 4: Configure SSL with Let's Encrypt (AC: 2, 3)
  - [ ] Install Certbot on VPS
  - [ ] Generate SSL certificate for domain
  - [ ] Configure auto-renewal
  - [ ] Update Nginx config with SSL certificates
  - [ ] Restart Nginx container
  - [ ] Verify HTTPS working

- [ ] Task 5: Implement Health Check Endpoint (AC: 4)
  - [ ] Create `app/api/health/route.ts`
  - [ ] Implement database connection check
  - [ ] Return JSON response with status
  - [ ] Test endpoint responds correctly

- [ ] Task 6: Configure DNS (AC: 3)
  - [ ] Point domain DNS to VPS IP (46.202.147.75)
  - [ ] Verify DNS propagation
  - [ ] Test domain accessibility

- [ ] Task 7: Verify Production Environment (AC: 1, 3, 5, 6)
  - [ ] Test HTTPS access via domain
  - [ ] Test health check endpoint
  - [ ] Verify database connection
  - [ ] Test all services running
  - [ ] Verify no errors in logs

---

## Dev Notes

### Previous Story Insights
[From Story 1.4]
- Docker setup complete
- docker-compose.yml configured
- Nginx reverse proxy configured
[From Story 1.5]
- CI/CD pipeline configured
- GitHub Actions workflow ready

### Health Check Endpoint
[Source: architecture/monitoring-logging.md - Section 12]

Implementation:
```typescript
// app/api/health/route.ts
import { prisma } from '@/lib/prisma';

export async function GET() {
  try {
    await prisma.$queryRaw`SELECT 1`;
    return Response.json({ status: 'ok', database: 'connected' });
  } catch (error) {
    return Response.json(
      { status: 'error', database: 'disconnected' },
      { status: 500 }
    );
  }
}
```

### SSL Configuration
[Source: architecture/deployment.md - Section 11]

Let's Encrypt setup:
- Install Certbot: `apt-get install certbot python3-certbot-nginx`
- Generate certificate: `certbot --nginx -d digitaldog.pet -d www.digitaldog.pet`
- Auto-renewal: Certbot configures cron job automatically
- Certificates location: `/etc/letsencrypt/live/digitaldog.pet/`

### Nginx SSL Configuration
[Source: architecture/deployment.md - Section 11]

Nginx must:
- Listen on port 443 with SSL
- Use SSL certificates from Let's Encrypt
- Redirect HTTP (80) to HTTPS (443)
- Configure SSL protocols (TLSv1.2, TLSv1.3)

### VPS Access
[Source: architecture/deployment.md - Section 11]

VPS details:
- Host: 46.202.147.75
- User: root
- SSH Script: `ssh_run.py` (local development)
- Project directory: `/var/www/digitaldog-website` (to be created)

### Environment Variables
[Source: architecture/environment-variables.md]

Production environment variables needed:
- DATABASE_URL: PostgreSQL connection string
- DB_PASSWORD: Database password
- NEXT_PUBLIC_GA_ID: (placeholder for now)
- NEXT_PUBLIC_FB_PIXEL_ID: (placeholder for now)
- EMAIL_API_KEY: (placeholder for now)
- CSRF_SECRET: Random 32-char secret

### File Locations
[Source: architecture/source-tree.md]

- Health check: `app/api/health/route.ts`
- Nginx config: `nginx.conf` (update with SSL paths)
- SSL certificates: `/etc/letsencrypt/live/digitaldog.pet/` (on VPS)

### DNS Configuration
[Source: prd/dependencias.md]

DNS must point to VPS IP:
- A record: `digitaldog.pet` â†’ 46.202.147.75
- A record: `www.digitaldog.pet` â†’ 46.202.147.75 (optional)

### Technical Constraints
- Let's Encrypt requires valid DNS pointing to VPS
- Domain must be accessible for certificate generation
- Nginx must be running before Certbot can configure SSL
- Health check must test actual database connection

### Testing
[Source: architecture/testing-strategy.md]

**Testing Standards:**
- Manual testing: Verify HTTPS access
- Test health check endpoint: `https://digitaldog.pet/api/health`
- Verify all containers running: `docker ps`
- Check logs: `docker-compose logs`
- For this story: Manual verification sufficient

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

---

