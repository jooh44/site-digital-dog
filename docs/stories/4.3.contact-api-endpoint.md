# Story 4.3: Contact API Endpoint

**Epic:** 4 - Conversion Flow  
**Status:** Draft  
**Sprint:** 4 (Semanas 7-8)  
**Prioridade:** ðŸ”´ CrÃ­tica

---

## Story

**As a** form submitter,  
**I want** my contact information to be saved to the database,  
**so that** Digital Dog can follow up with me.

---

## Acceptance Criteria

1. POST /api/contact endpoint created
2. Request body validated with Zod schema
3. Contact saved to PostgreSQL via Prisma
4. Error handling implemented (400, 500)
5. Success response returns contactId
6. Endpoint is secure (CSRF, rate limiting)

---

## Tasks / Subtasks

- [ ] Task 1: Create API Route (AC: 1)
  - [ ] Create `app/api/contact/route.ts`
  - [ ] Implement POST handler
  - [ ] Set up route structure

- [ ] Task 2: Implement Validation (AC: 2)
  - [ ] Create Zod schema matching form validation
  - [ ] Validate request body
  - [ ] Return 400 error for invalid data

- [ ] Task 3: Save to Database (AC: 3)
  - [ ] Use Prisma Client to create Contact
  - [ ] Handle database errors
  - [ ] Return created contact with ID

- [ ] Task 4: Implement Error Handling (AC: 4)
  - [ ] Handle validation errors (400)
  - [ ] Handle database errors (500)
  - [ ] Return appropriate error messages
  - [ ] Log errors for debugging

- [ ] Task 5: Implement Security (AC: 6)
  - [ ] Add CSRF protection (if needed)
  - [ ] Add rate limiting (middleware)
  - [ ] Sanitize input data

- [ ] Task 6: Connect Form to API (AC: 1-6)
  - [ ] Update DiagnosticoForm to submit to /api/contact
  - [ ] Handle success/error responses
  - [ ] Show success message
  - [ ] Redirect or show next steps

---

## Dev Notes

### Previous Story Insights
[From Story 1.3]
- Prisma Client configured
- Contact model created
[From Story 4.1]
- Form component created
- Zod validation schema exists

### API Endpoint Specification
[Source: architecture/api-endpoints.md - Section 6]

**POST /api/contact**

Request Body:
```typescript
{
  name: string;
  email: string;
  phone: string;
  clinicName: string;
  city: string;
  state: string;
  monthlyRevenue: string;
  mainChallenge: string;
  referralSource?: string;
  acceptsEmails: boolean;
}
```

Response (Success - 201):
```typescript
{
  success: true;
  message: "Contato salvo com sucesso";
  contactId: "clxx...";
}
```

Response (Error - 400/500):
```typescript
{
  success: false;
  error: "Mensagem do erro";
}
```

### Validation
[Source: architecture/api-endpoints.md - Section 6]

Use Zod schema matching form validation. Same schema should be used in both form and API.

### Database
[Source: architecture/database-schema.md - Section 5]

Use Prisma Client to create Contact:
```typescript
const contact = await prisma.contact.create({
  data: {
    name,
    email,
    phone,
    clinicName,
    city,
    state,
    monthlyRevenue,
    mainChallenge,
    referralSource,
    acceptsEmails,
  },
});
```

### Security
[Source: architecture/security.md - Section 10]

- CSRF protection (if using sessions)
- Rate limiting (5 requests per minute)
- Input sanitization (Zod handles this)

### File Locations
[Source: architecture/source-tree.md]

- API route: `app/api/contact/route.ts`
- Form component: `components/forms/DiagnosticoForm.tsx`

### Testing
[Source: architecture/testing-strategy.md]

**Testing Standards:**
- Test successful submission
- Test validation errors
- Test database errors
- Test rate limiting
- For this story: Manual testing sufficient (E2E tests in later story)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

---

