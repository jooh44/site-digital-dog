# Story 1.4: Docker & Infrastructure

**Epic:** 1 - Foundation & Setup  
**Status:** Draft  
**Sprint:** 1-2 (Semanas 1-2)  
**Prioridade:** ðŸ”´ CrÃ­tica

---

## Story

**As a** developer,  
**I want** to set up Docker containers for Next.js, PostgreSQL, and Nginx with docker-compose,  
**so that** the application can run in a containerized environment matching production.

---

## Acceptance Criteria

1. Dockerfile created for Next.js application
2. docker-compose.yml configured with all services (Next.js, PostgreSQL, Nginx)
3. Nginx reverse proxy configured
4. Volumes and networking properly configured
5. Docker containers can start and communicate
6. Application accessible via Nginx on port 80/443

---

## Tasks / Subtasks

- [ ] Task 1: Create Dockerfile (AC: 1)
  - [ ] Create multi-stage Dockerfile
  - [ ] Configure base image (node:20-alpine)
  - [ ] Setup dependencies stage
  - [ ] Setup builder stage (with Prisma generate and build)
  - [ ] Setup runner stage (production optimized)
  - [ ] Configure user permissions (nextjs user)
  - [ ] Expose port 3000

- [ ] Task 2: Create docker-compose.yml (AC: 2, 4)
  - [ ] Define Next.js service
  - [ ] Define PostgreSQL service (postgres:16-alpine)
  - [ ] Define Nginx service
  - [ ] Configure environment variables
  - [ ] Setup service dependencies (depends_on)
  - [ ] Configure volumes (postgres_data, backups)
  - [ ] Configure networking

- [ ] Task 3: Configure Nginx (AC: 3, 6)
  - [ ] Create `nginx.conf` file
  - [ ] Configure HTTP to HTTPS redirect
  - [ ] Configure SSL server block (port 443)
  - [ ] Setup reverse proxy to Next.js (port 3000)
  - [ ] Configure static asset caching
  - [ ] Setup proxy headers (X-Real-IP, X-Forwarded-For, etc.)

- [ ] Task 4: Configure Volumes (AC: 4)
  - [ ] Setup PostgreSQL data volume
  - [ ] Setup backups directory volume
  - [ ] Configure SSL certificates directory (for future SSL setup)
  - [ ] Ensure volumes persist data

- [ ] Task 5: Update Next.js Config for Docker (AC: 1)
  - [ ] Verify `output: 'standalone'` in next.config.js
  - [ ] Ensure standalone output includes necessary files
  - [ ] Test build produces standalone output

- [ ] Task 6: Create .dockerignore (AC: 1)
  - [ ] Exclude node_modules
  - [ ] Exclude .next
  - [ ] Exclude .git
  - [ ] Exclude docs/ (optional)
  - [ ] Exclude environment files

- [ ] Task 7: Test Docker Setup (AC: 5, 6)
  - [ ] Build Docker images: `docker-compose build`
  - [ ] Start containers: `docker-compose up -d`
  - [ ] Verify all containers running
  - [ ] Test Next.js accessible via Nginx
  - [ ] Test PostgreSQL connection from Next.js
  - [ ] Verify logs show no errors

---

## Dev Notes

### Previous Story Insights
[From Story 1.1]
- Next.js project initialized
- next.config.js configured with standalone output
[From Story 1.3]
- Prisma schema created
- Database connection configured

### Dockerfile Specification
[Source: architecture/deployment.md - Section 11]

Multi-stage Dockerfile structure:
1. **base**: node:20-alpine
2. **deps**: Install dependencies (npm ci)
3. **builder**: Copy code, generate Prisma, build Next.js
4. **runner**: Production image with only necessary files

Key points:
- Use `node:20-alpine` for smaller image size
- Run `npx prisma generate` in builder stage
- Copy `.next/standalone` and `.next/static` to runner
- Use non-root user (nextjs) for security
- Expose port 3000

### Docker Compose Configuration
[Source: architecture/deployment.md - Section 11]

Services:
- **nextjs**: Builds from Dockerfile, depends on postgres, exposes 3000
- **postgres**: postgres:16-alpine, volumes for data and backups
- **nginx**: nginx:alpine, depends on nextjs, exposes 80/443

Environment variables:
- DATABASE_URL: postgresql://digitaldog:${DB_PASSWORD}@postgres:5432/digitaldog_db
- NEXT_PUBLIC_GA_ID, NEXT_PUBLIC_FB_PIXEL_ID (for later)

### Nginx Configuration
[Source: architecture/deployment.md - Section 11]

Nginx config must:
- Redirect HTTP (80) to HTTPS (443)
- Proxy requests to Next.js on port 3000
- Cache static assets (_next/static/)
- Set proper proxy headers
- Configure SSL (certificates to be added in Story 1.6)

### Volumes
[Source: architecture/deployment.md - Section 11]

- `postgres_data`: PostgreSQL data persistence
- `./backups:/backups`: Backup directory mount
- `./nginx.conf:/etc/nginx/nginx.conf`: Nginx config
- `./ssl:/etc/nginx/ssl`: SSL certificates (for Story 1.6)

### File Locations
[Source: architecture/source-tree.md]

- Dockerfile: Root directory
- docker-compose.yml: Root directory
- nginx.conf: Root directory
- .dockerignore: Root directory

### Environment Variables
[Source: architecture/environment-variables.md]

Required for docker-compose:
- DB_PASSWORD: PostgreSQL password
- DATABASE_URL: Full connection string
- GA_ID, FB_PIXEL_ID: For later stories (can be placeholders)

### Technical Constraints
- Docker version must be 25 or higher
- Docker Compose version 3.8
- Next.js must use standalone output
- PostgreSQL must be 16-alpine
- Nginx must be alpine version

### Testing
[Source: architecture/testing-strategy.md]

**Testing Standards:**
- Manual testing: Verify containers start and communicate
- Test database connection from Next.js container
- Test Nginx proxy to Next.js
- For this story: Manual verification sufficient

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

---

