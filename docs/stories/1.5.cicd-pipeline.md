# Story 1.5: CI/CD Pipeline

**Epic:** 1 - Foundation & Setup  
**Status:** Draft  
**Sprint:** 1-2 (Semanas 1-2)  
**Prioridade:** ðŸ”´ CrÃ­tica

---

## Story

**As a** developer,  
**I want** to configure GitHub Actions CI/CD pipeline for automatic deployment to VPS,  
**so that** code changes are automatically deployed to production when pushed to main branch.

---

## Acceptance Criteria

1. GitHub Actions workflow created
2. SSH setup configured for VPS access
3. Deploy script executes on push to main
4. Secrets configured in GitHub repository
5. Pipeline successfully deploys to VPS
6. Database migrations run automatically on deploy

---

## Tasks / Subtasks

- [ ] Task 1: Create GitHub Actions Workflow (AC: 1)
  - [ ] Create `.github/workflows/deploy.yml`
  - [ ] Configure trigger (push to main branch)
  - [ ] Setup job runner (ubuntu-latest)
  - [ ] Add checkout step

- [ ] Task 2: Configure SSH Access (AC: 2, 4)
  - [ ] Add SSH agent setup step
  - [ ] Configure SSH key from GitHub Secrets
  - [ ] Document required GitHub Secrets:
    - [ ] VPS_SSH_KEY (private SSH key)
    - [ ] VPS_USER (deploy user)
    - [ ] VPS_HOST (VPS IP address)

- [ ] Task 3: Create Deploy Script (AC: 3, 6)
  - [ ] SSH into VPS
  - [ ] Navigate to project directory
  - [ ] Pull latest code from GitHub
  - [ ] Stop containers (docker-compose down)
  - [ ] Build new images (docker-compose build)
  - [ ] Start containers (docker-compose up -d)
  - [ ] Run database migrations (prisma migrate deploy)

- [ ] Task 4: Configure GitHub Secrets (AC: 4)
  - [ ] Document all required secrets
  - [ ] Provide instructions for adding secrets
  - [ ] Verify secrets are properly configured

- [ ] Task 5: Test Pipeline (AC: 5)
  - [ ] Push test commit to main branch
  - [ ] Verify workflow triggers
  - [ ] Monitor deployment process
  - [ ] Verify deployment succeeds
  - [ ] Verify application is accessible

- [ ] Task 6: Add Error Handling (AC: 5)
  - [ ] Add error handling in deploy script
  - [ ] Configure workflow to fail on errors
  - [ ] Add notification on failure (optional)

---

## Dev Notes

### Previous Story Insights
[From Story 1.1]
- GitHub repository created
- Project structure established
[From Story 1.4]
- Docker setup complete
- docker-compose.yml configured

### GitHub Actions Workflow
[Source: architecture/deployment.md - Section 11]

Workflow structure:
```yaml
name: Deploy to VPS
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /var/www/digitaldog-website
            git pull origin main
            docker-compose down
            docker-compose build
            docker-compose up -d
            docker-compose exec -T nextjs npx prisma migrate deploy
          EOF
```

### SSH Configuration
[Source: architecture/deployment.md - Section 11]

- Use `webfactory/ssh-agent@v0.9.0` action
- SSH key stored in GitHub Secrets as VPS_SSH_KEY
- VPS user and host in secrets (VPS_USER, VPS_HOST)
- Disable strict host key checking for automation

### Deploy Process
[Source: architecture/deployment.md - Section 11]

Deploy steps:
1. Pull latest code from GitHub
2. Stop running containers
3. Build new Docker images
4. Start containers
5. Run database migrations (prisma migrate deploy)

**Note:** Use `prisma migrate deploy` (not `migrate dev`) for production deployments.

### GitHub Secrets Required
[Source: architecture/environment-variables.md]

Required secrets:
- `VPS_SSH_KEY`: Private SSH key for VPS access
- `VPS_USER`: SSH user (typically "deploy" or "root")
- `VPS_HOST`: VPS IP address (46.202.147.75)

**Note:** These should be configured in GitHub repository settings â†’ Secrets and variables â†’ Actions.

### File Locations
[Source: architecture/source-tree.md]

- Workflow: `.github/workflows/deploy.yml`

### VPS Access
[Source: architecture/deployment.md - Section 11]

VPS details:
- Host: 46.202.147.75
- User: root (or deploy user if created)
- Project directory: `/var/www/digitaldog-website` (assumed, may need to be created)

### Database Migrations
[Source: architecture/database-schema.md]

Use `prisma migrate deploy` for production:
- Applies pending migrations
- Does not create new migrations
- Safe for production use

### Technical Constraints
- GitHub Actions runner: ubuntu-latest
- SSH key must have access to VPS
- VPS must have Git repository cloned
- Docker and docker-compose must be installed on VPS

### Testing
[Source: architecture/testing-strategy.md]

**Testing Standards:**
- Manual testing: Push to main and verify deployment
- Verify all steps execute successfully
- Verify application is accessible after deploy
- For this story: Manual verification sufficient

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Initial story creation | SM (Bob) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

---

