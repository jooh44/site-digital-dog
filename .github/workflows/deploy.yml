name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to project directory
            cd /var/www/digitaldog-website || {
              echo "âŒ Project directory not found. Creating..."
              mkdir -p /var/www/digitaldog-website
              cd /var/www/digitaldog-website
              git clone https://github.com/${{ github.repository }}.git .
            }
            
            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Stop containers
            echo "ðŸ›‘ Stopping containers..."
            docker-compose down || true
            
            # Build new images
            echo "ðŸ”¨ Building Docker images..."
            docker-compose build --no-cache
            
            # Start containers
            echo "â–¶ï¸ Starting containers..."
            docker-compose up -d
            
            # Wait for services to be ready
            echo "â³ Waiting for services to be ready..."
            sleep 10
            
            # Run database migrations
            echo "ðŸ—„ï¸ Running database migrations..."
            docker-compose exec -T nextjs npx prisma migrate deploy || {
              echo "âš ï¸ Migration failed, but continuing..."
            }
            
            # Verify deployment
            echo "âœ… Verifying deployment..."
            docker-compose ps
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          EOF

      - name: Deployment Status
        if: failure()
        run: |
          echo "âŒ Deployment failed. Check logs above for details."

